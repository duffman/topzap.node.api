'use strict';Object.defineProperty(exports,'__esModule',{value:true});const basket_item_model_1=require('../../zap-ts-models/basket/basket-item.model');const vendor_basket_model_1=require('../../zap-ts-models/basket/vendor-basket.model');const session_basket_1=require('../../zap-ts-models/session-basket');const prand_num_1=require('../../../lib/putte-ts/prand-num');const product_db_1=require('../../../database/product-db');const barcode_parser_1=require('../../../lib/topzap-utils-lib/barcode-parser');const session_keys_1=require('../../types/session-keys');const cli_logger_1=require('../../cli/cli.logger');const basket_utils_1=require('./basket-utils');const util_1=require('util');class BasketHandler{constructor(){}getSessionBasket(session){console.log('Get Session Basket >>>> A:2');let res=session.get(session_keys_1.SessionKeys.Basket);if(!res){res=this.ensureBasket(res);session.set(session_keys_1.SessionKeys.Basket,res);}console.log('Get Session Basket >>>> A:3',res);return res;}ensureBasket(sessionBasket){if(!sessionBasket){sessionBasket=new session_basket_1.SessionBasket();console.log('ensureBasket >> We\xB4re creating the basket ::',sessionBasket.data);}return sessionBasket;}addToBasket(session,offerData){let scope=this;console.log('Get Session Basket >>>> A:1');let sessBasket=this.getSessionBasket(session);cli_logger_1.Logger.logPurple('## addToBasket');basket_utils_1.BasketUtils.showBasket(sessBasket);cli_logger_1.Logger.logPurple('## BEGIN::BASKET ## addToBasket ##');basket_utils_1.BasketUtils.showBasket(sessBasket);cli_logger_1.Logger.logPurple('## END:BASKET ##');if(!offerData.accepted){console.log('NOT ACCEPTED');return false;}let vendorOffer=parseFloat(offerData.offer);let resultItem=new basket_item_model_1.BasketItem(prand_num_1.PRandNum.randomNum(),1,offerData.code,offerData.vendorId,offerData.title,vendorOffer);return this.addToVendorBasket(session,resultItem);}getVendorBasket(sessBasket,vendorId){let result=null;console.log('Get getVendorBasket ##### sessBasket.data',sessBasket.data);if(!sessBasket.data){console.log('IT WAS UNASSIGNED!!!!!');sessBasket.data=new Array();}for(let i=0;i<sessBasket.data.length;i++){let basket=sessBasket.data[i];if(basket.vendorId===vendorId){result=basket;break;}}if(result===null){result=new vendor_basket_model_1.VendorBasketModel(vendorId);sessBasket.data.push(result);}console.log('WE`re FINE!!!!!');return result;}addToVendorBasket(session,item){let sessBasket=this.getSessionBasket(session);let basket=this.getVendorBasket(sessBasket,item.vendorId);cli_logger_1.Logger.logPurple(':::::::: BASKET BEFORE ADD :::::::::::');let cp=session.get(session_keys_1.SessionKeys.Basket);basket_utils_1.BasketUtils.showBasket(cp);cli_logger_1.Logger.logPurple(':::::::: ////// BASKET BEFORE ADD :::::::::::');let existingItem=basket.items.find(o=>o.code===item.code);if(typeof existingItem==='object'){existingItem.count++;}else{basket.items.push(item);}console.log('\n\n');basket_utils_1.BasketUtils.showBasket(sessBasket);console.log(':: INSPECT ::',util_1.inspect(sessBasket));console.log('\n\n');session.set(session_keys_1.SessionKeys.Basket,sessBasket);return true;}getBasketTotal(basket){let total=0;if(basket.items===null)return 0;for(let index in basket.items){let item=basket.items[index];total=total+item.offer;}return total;}getBestBasket(session){let vendorBaskets=this.getSessionBasket(session);let bestTotal=0;let bestBaset=null;console.log('getBestBasket ::',bestBaset);for(let index in vendorBaskets.data){let basket=vendorBaskets.data[index];let total=this.getBasketTotal(basket);if(total>bestTotal){bestTotal=total;bestBaset=basket;}}return bestBaset;}extendSessionBasket(data){let prodDb=new product_db_1.ProductDb();return new Promise((resolve,reject)=>{prodDb.getProducts(['0819338020068','0887195000424']).then(res=>{}).catch(err=>{console.log('extendSessionBasket :: err ::',err);});});}getBasketCodes(sessionBasket){let result=new Array();if(!sessionBasket){return result;}function addBarcode(code){code=barcode_parser_1.BarcodeParser.prepEan13Code(code);if(result.indexOf(code)===-1){result.push(code);}}for(const vendorBasket of sessionBasket.data){for(const item of vendorBasket.items){addBarcode(item.code);}}return result;}getFullBasket(session){let sessBasket=this.getSessionBasket(session);console.log('getFullBasket :: sessBasket ::',sessBasket);return sessBasket;}sortSessionBasket(sessionBasket){this.ensureBasket(sessionBasket);for(const basket of sessionBasket.data){basket.totalValue=this.getBasketTotal(basket);}sessionBasket.data=sessionBasket.data.sort((x,y)=>{if(x.totalValue>y.totalValue){return-1;}if(x.totalValue<y.totalValue){return 1;}return 0;});return sessionBasket;}attachVendors(sessBasket,vendors){function getVendorDataById(vendorId){let result=null;for(let vendorData of vendors){if(vendorData.id===vendorId){result=vendorData;break;}}return result;}for(let vendorBasket of sessBasket.data){let vendorData=getVendorDataById(vendorBasket.vendorId);vendorBasket.vendorData=vendorData;}}calcBasketTotals(sessBasket){if(!sessBasket.data){cli_logger_1.Logger.logError('calcBasketTotals :: no data');return;}for(let vendorBasket of sessBasket.data){vendorBasket.totalValue=this.getBasketTotal(vendorBasket);}}getExtSessionBasket(session){let scope=this;let sessBasket=this.getFullBasket(session);let prodDb=new product_db_1.ProductDb();let codes=this.getBasketCodes(sessBasket);function getProducts(){console.log('getProducts >>>>>');return new Promise((resolve,reject)=>{let codes=scope.getBasketCodes(sessBasket);return prodDb.getProducts(codes).then(res=>{console.log('FETRES :::',res);resolve(res);}).catch(err=>{console.log('getExtSessionBasket :: err ::',err);reject(err);});});}function getVendors(){console.log('getVendors >>>>>');return new Promise((resolve,reject)=>{return prodDb.getVendors().then(res=>{resolve(res);}).catch(err=>{console.log('getExtSessionBasket :: err ::',err);});});}function getProdData(code,prodData){console.log('getProdData >>>>>');let res=null;for(let prod of prodData){if(prod.code===code){res=prod;break;}}return res;}function attachProductInfoToItem(sessBasket){console.log('attachProductInfoToItem >>>>>');scope.ensureBasket(sessBasket);for(let vb of sessBasket.data){for(let item of vb.items){let prodData=getProdData(item.code,sessBasket.productData);item.thumbImage=prodData.thumbImage;item.platformIcon=prodData.platformIcon;item.releaseDate=prodData.releaseDate;console.log('YAYAYAYAY prodData:::',prodData);}}}async function getSessionBasket(){try{let prodData=await getProducts();sessBasket.productData=prodData;let vendors=await getVendors();console.log('getSessionBasket ::',prodData);sessBasket=scope.sortSessionBasket(sessBasket);attachProductInfoToItem(sessBasket);for(let vbasket of sessBasket.data){vbasket.highestBidder=false;}if(sessBasket.data.length>0){sessBasket.data[0].highestBidder=true;console.log('HIGH BID SET ::',sessBasket.data[0]);}for(let b of sessBasket.data){console.log('BDATA ::',b);}scope.attachVendors(sessBasket,vendors);scope.calcBasketTotals(sessBasket);}catch(err){console.log('getExtSessionBasket :: getSessionBasket ::',err);}}return new Promise((resolve,reject)=>{getSessionBasket().then(()=>{resolve(sessBasket);}).catch(err=>{cli_logger_1.Logger.logFatalError('getExtSessionBasket');reject(err);});});}showBasket(session){let basket=this.getSessionBasket(session);for(const vendorData of basket.data){console.log('BASKET :: VENDOR ::',vendorData.vendorId);for(const item of vendorData.items){console.log('  ITEM ::',item);}}}removeProductByCode(code,basket=null){let result=false;basket.productData=!basket.productData?new Array():basket.productData;for(let i=0;i<basket.productData.length;i++){let product=basket.productData[i];if(product.code===code){basket.productData.splice(i,1);result=true;break;}}return result;}removeItemByCode(code,basket=null){let result=false;this.removeProductByCode(code,basket);console.log('removeItemByCode :: removeProductByCode ::',basket);for(const vendorData of basket.data){console.log('VENDOR BASKET ::',vendorData);for(let i=0;i<vendorData.items.length;i++){let item=vendorData.items[i];if(item.code===code){vendorData.items.splice(i,1);result=true;break;}}}return result;}}exports.BasketHandler=BasketHandler;