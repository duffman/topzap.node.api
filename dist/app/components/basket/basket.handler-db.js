'use strict';Object.defineProperty(exports,'__esModule',{value:true});const basket_item_model_1=require('../../zap-ts-models/basket/basket-item.model');const prand_num_1=require('../../../lib/putte-ts/prand-num');const product_db_1=require('../../../database/product-db');const barcode_parser_1=require('../../../lib/topzap-utils-lib/barcode-parser');const product_item_types_1=require('../../zap-ts-models/product-item-types');const cli_debug_yield_1=require('../../cli/cli.debug-yield');const cli_logger_1=require('../../cli/cli.logger');class BasketHandlerDb{constructor(sessManager){this.sessManager=sessManager;}getSessionBasket(sessId){return this.sessManager.getSessionBasket(sessId);}addToBasket(sessId,offerData){return new Promise((resolve,reject)=>{this.getSessionBasket(sessId).then(sessBasket=>{if(!offerData.accepted){console.log('NOT ACCEPTED');return false;}let vendorOffer=parseFloat(offerData.offer);let resultItem=new basket_item_model_1.BasketItem(prand_num_1.PRandNum.randomNum(),1,offerData.code,offerData.vendorId,offerData.title,vendorOffer);return this.addToVendorBasket(sessId,resultItem);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'addToBasket',err);reject(err);});});}addToVendorBasket(sessId,item){return new Promise((resolve,reject)=>{return this.getSessionBasket(sessId).then(sessBasket=>{for(let vendorBasket of sessBasket.data){let existingItem=vendorBasket.items.find(o=>o.code===item.code);if(typeof existingItem==='object'){existingItem.count++;}else{vendorBasket.items.push(item);}}return this.sessManager.setSessionBasket(sessId,sessBasket);});});}findVendorBasketInSession(vendorId,sessionBasket){let result=null;for(let i=0;i<sessionBasket.data.length;i++){let basket=sessionBasket.data[i];if(basket.vendorId===vendorId){result=basket;break;}}return result;}findItemByCodeInVendorBasket(code,vendorBasket){let result=null;for(let i=0;i<vendorBasket.items.length;i++){let item=vendorBasket.items[i];if(item.code===code){result=item;break;}}return result;}getVendorBasket(sessId,vendorId){let result=null;return new Promise((resolve,reject)=>{return this.getSessionBasket(sessId).then(sessBasket=>{let basket=this.findVendorBasketInSession(vendorId,sessBasket);resolve(basket);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'getVendorBasket',err);reject(err);});});}getBasketTotal(basket){let total=0;for(let index in basket.items){let item=basket.items[index];total=total+item.offer;}return total;}getBestBasket(sessId){let bestTotal=0;let bestBaset=null;return new Promise((resolve,reject)=>{return this.getSessionBasket(sessId).then(sessBasket=>{console.log('getBestBasket ::',bestBaset);for(let index in sessBasket.data){let basket=sessBasket.data[index];let total=this.getBasketTotal(basket);if(total>bestTotal){bestTotal=total;bestBaset=basket;}}resolve(bestBaset);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'getBestBasket',err);reject(err);});});}extendSessionBasket(data){let prodDb=new product_db_1.ProductDb();return new Promise((resolve,reject)=>{prodDb.getProducts(['0819338020068','0887195000424']).then(res=>{}).catch(err=>{console.log('extendSessionBasket :: err ::',err);});});}getBasketCodes(sessionBasket){let result=new Array();function addBarcode(code){code=barcode_parser_1.BarcodeParser.prepEan13Code(code);if(result.indexOf(code)===-1){result.push(code);}}for(const vendorBasket of sessionBasket.data){for(const item of vendorBasket.items){addBarcode(item.code);}}return result;}getFullBasket(sessId){return new Promise((resolve,reject)=>{return this.getSessionBasket(sessId).then(sessBasket=>{console.log('getFullBasket :: sessBasket ::',sessBasket);resolve(sessBasket);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'getFullBasket',err);reject(err);});});}sortSessionBasket(sessionBasket){for(const basket of sessionBasket.data){basket.totalValue=this.getBasketTotal(basket);}sessionBasket.data=sessionBasket.data.sort((x,y)=>{if(x.totalValue>y.totalValue){return-1;}if(x.totalValue<y.totalValue){return 1;}return 0;});return sessionBasket;}attachVendors(sessBasket,vendors){console.log('attachVendors ::',sessBasket);function getVendorDataById(vendorId){let result=null;for(let vendorData of vendors){if(vendorData.id===vendorId){result=vendorData;break;}}return result;}for(let vendorBasket of sessBasket.data){console.log('attachVendors :: LOOPING :: vendorBasket ::',vendorBasket);let vendorData=getVendorDataById(vendorBasket.vendorId);vendorBasket.vendorData=vendorData;}}calcBasketTotals(sessBasket){for(let vendorBasket of sessBasket.data){vendorBasket.totalValue=this.getBasketTotal(vendorBasket);}}generateZid(){let zid=prand_num_1.PRandNum.getRandomInt(10,22000).toFixed(2);return zid;}getExtSessionBasket(sessId){cli_logger_1.Logger.logGreen('****** getExtSessionBasket');let scope=this;let sessBasket=null;let prodDb=new product_db_1.ProductDb();function getFullBasket(){return new Promise((resolve,reject)=>{return this.getFullBasket(sessId);});}function getProducts(){return new Promise((resolve,reject)=>{let codes=scope.getBasketCodes(sessBasket);return prodDb.getProducts(codes).then(res=>{console.log('FETRES :::',res);resolve(res);}).catch(err=>{console.log('getExtSessionBasket :: err ::',err);reject(err);});});}function getVendors(){return new Promise((resolve,reject)=>{return prodDb.getVendors().then(res=>{resolve(res);}).catch(err=>{console.log('getExtSessionBasket :: err ::',err);});});}function getCoreProductData(code,prodData){let res=null;for(let prod of prodData){if(prod.code===code){res=prod;break;}}return res;}function getGameProductData(code,prodData){let res=null;for(let prod of prodData){if(prod.code===code){res=prod;break;}}return res;}function getProductData(code,prodType,sessBasket){let result;switch(prodType){case product_item_types_1.ProductItemTypes.GAME:{getGameProductData(code,sessBasket.productData);}}return result;}function attachProductInfoToItem(sessBasket){cli_logger_1.Logger.logGreen('--------------------------------');cli_logger_1.Logger.logGreen('sessBasket ::',sessBasket);cli_logger_1.Logger.logGreen('--------------------------------');for(let vb of sessBasket.data){for(let vbItem of vb.items){let gameBasketItem=vbItem;let prodData=getGameProductData(gameBasketItem.code,sessBasket.productData);gameBasketItem.zid=scope.generateZid();gameBasketItem.code=prodData.code;gameBasketItem.id=prodData.id;gameBasketItem.itemType=product_item_types_1.ProductItemTypes.GAME;gameBasketItem.vendorId=vbItem.vendorId;gameBasketItem.title=prodData.title;gameBasketItem.offer=vbItem.offer;gameBasketItem.thumbImage=prodData.thumbImage;gameBasketItem.platformIcon=prodData.platformIcon;gameBasketItem.count=vbItem.count;gameBasketItem.platformName=prodData.platformName;gameBasketItem.publisher=prodData.publisher;gameBasketItem.releaseDate=prodData.releaseDate;}}}async function getSessionBasket(){try{sessBasket=await getFullBasket();let prodDb=new product_db_1.ProductDb();let codes=this.getBasketCodes(sessBasket);let prodData=await getProducts();sessBasket.productData=prodData;let vendors=await getVendors();console.log('getSessionBasket ::',prodData);sessBasket=scope.sortSessionBasket(sessBasket);console.log('getSessionBasket :: SORTED ::',sessBasket);attachProductInfoToItem(sessBasket);console.log('getSessionBasket :: ATTACHED ::',sessBasket);for(let vbasket of sessBasket.data){vbasket.highestBidder=false;}if(sessBasket.data.length>0){sessBasket.data[0].highestBidder=true;console.log('HIGH BID SET ::',sessBasket.data[0]);}for(let b of sessBasket.data){console.log('BDATA ::',b);}scope.attachVendors(sessBasket,vendors);scope.calcBasketTotals(sessBasket);}catch(err){let errMessage='getExtSessionBasket :: ERROR ::';cli_logger_1.Logger.logError(errMessage,err);cli_debug_yield_1.CliDebugYield.fatalError(errMessage,err,true);}}return new Promise((resolve,reject)=>{getSessionBasket().then(()=>{resolve(sessBasket);});});}showBasket(sessId){this.sessManager.getSessionBasket(sessId).then(basket=>{for(const vendorData of basket.data){for(const item of vendorData.items){console.log('  ITEM ::',item.title+' '+item.offer);}}}).catch(err=>{cli_logger_1.Logger.logAppError(this,'showBasket',err);});}removeProductByCode(sessId,code,basket=null){let result=false;async function excecute(){if(basket===null){basket=await this.sessManager.getSessionBasket(sessId);}basket.productData=!basket.productData?new Array():basket.productData;for(let i=0;i<basket.productData.length;i++){let product=basket.productData[i];if(product.code===code){basket.productData.splice(i,1);result=true;break;}}}return new Promise((resolve,reject)=>{excecute().then(()=>{resolve(result);});});}removeItemFromBasket(code,basket){let result=false;if(basket===null){return result;}for(const vendorData of basket.data){console.log('VENDOR BASKET ::',vendorData);for(let i=0;i<vendorData.items.length;i++){let item=vendorData.items[i];if(item.code===code){vendorData.items.splice(i,1);result=true;break;}}}return result;}removeItemByCode(sessId,code,basket=null){let result=false;console.log('removeItemByCode ::',basket);return new Promise((resolve,reject)=>{if(basket===null){return this.sessManager.getSessionBasket(sessId).then(sessBasket=>{this.removeItemFromBasket(code,sessBasket);return this.sessManager.setSessionBasket(sessId,sessBasket).then(res=>{resolve(res);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'removeItemByCode',err);reject(err);});}).catch(err=>{cli_logger_1.Logger.logAppError(this,'getSessionBasket :: ERROR ::',err);reject(err);});}else{this.removeItemFromBasket(code,basket);return this.sessManager.setSessionBasket(sessId,basket).then(res=>{resolve(res);}).catch(err=>{cli_logger_1.Logger.logAppError(this,'removeItemByCode',err);reject(err);});}});}}exports.BasketHandlerDb=BasketHandlerDb;