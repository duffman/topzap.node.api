'use strict';Object.defineProperty(exports,'__esModule',{value:true});const miner_status_1=require('../miner/miner-status');const express=require('express');const express_1=require('express');const bodyParser=require('body-parser');const cookieParser=require('cookie-parser');const database_manager_1=require('../lib/putte-db/database-manager');const cli_logger_1=require('./cli/cli.logger');const miner_api_controller_1=require('./api/miner-api-controller');const product_db_1=require('../database/product-db');const service_api_controller_1=require('./api/service-api-controller');const cli_commander_1=require('./cli/cli.commander');const search_api_controller_1=require('./api/search-api-controller');class ZapApp{constructor(includeMinerApi=false){this.includeMinerApi=includeMinerApi;this.port=8080;this.webRoutes=express_1.Router();this.apiControllers=new Array();this.webServer=express();this.db=new database_manager_1.DbManager();this.productDb=new product_db_1.ProductDb();this.init();}getVersion(){return'ZapApp-Node-API/1.6.5';}test(barcode){return new Promise((resolve,reject)=>{this.productDb.getProductOffers(barcode,false,false).then(result=>{resolve(result);}).catch(error=>{cli_logger_1.Logger.logError('Error in test',error);});});}initControllers(){const routes=this.webRoutes;const controllers=this.apiControllers;controllers.push(new search_api_controller_1.SearchApiController());controllers.push(new service_api_controller_1.ServiceApiController());controllers.push(new miner_api_controller_1.MinerApiController());routes.get('/snora',function(req,resp){resp.json({snor:'ja ett snor-luder'});console.log('SNOR!!!!!');});this.webRoutes.get('/robo',function(req,resp){resp.json({snor:'ja ett snor-luder'});console.log('SNOR!!!!!');});console.log('ADD CONTROLLERS');for(let index in controllers){let controller=controllers[index];console.log('ADDING ::',controller);controller.initRoutes(routes);}}configureWebServer(){let app=this.webServer;app.set('view engine','ejs');app.use(cookieParser());app.use(bodyParser.json());app.use(bodyParser.urlencoded({extended:true}));app.use(function(req,res,next){res.header('Access-Control-Allow-Origin','*');res.header('Access-Control-Allow-Headers','Origin, X-Requested-With, Content-Type, Accept');next();});}init(){let app=this.webServer;this.configureWebServer();this.initControllers();app.get('/hora',function(req,resp){resp.json({hora:'ja ett luder'});console.log('HORA!!!!!');});app.post('/hora2',function(req,resp){resp.json({hora:'som fan'});console.log('HORA!!!!!');});app.get('/minerstats',function(req,res){let stat=new miner_status_1.MinerStatus();stat.getProgressInfo().then(data=>{console.log(data);res.render('pages/minerstats',{progData:data});});});app.use(express.static('public'));app.get('/res/:filename',(req,res)=>{let filename=req.params.code;console.log('Get file',filename);});app.listen(this.port);console.log(`Listening on localhost: ${this.port}`);}}exports.ZapApp=ZapApp;if(cli_commander_1.CliCommander.debug()){let minerApi=true;let app=new ZapApp(minerApi);}