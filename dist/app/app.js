'use strict';Object.defineProperty(exports,'__esModule',{value:true});const miner_status_1=require('../miner/miner-status');const express=require('express');const express_1=require('express');const bodyParser=require('body-parser');const cookieParser=require('cookie-parser');const session=require('express-session');const cors=require('cors');const db_kernel_1=require('../lib/putte-db/db-kernel');const cli_logger_1=require('./cli/cli.logger');const miner_api_controller_1=require('./api/miner-api-controller');const service_api_controller_1=require('./api/rest/service-api.controller');const search_ws_api_controller_1=require('./api/ws/search-ws-api.controller');const product_api_controller_1=require('./api/rest/product-api.controller');const basket_api_controller_1=require('./api/rest/basket-api.controller');const data_dump_api_controller_1=require('./api/data-dump-api.controller');const zyn_socket_server_1=require('../lib/coldmind-igniter/coldmind/zyn-socket.server');const socket_io_client_1=require('../lib/coldmind-igniter/coldmind/socket-io.client');const data_cache_controller_1=require('./api/data-cache-controller');const basket_ws_api_controller_1=require('./api/ws/basket-ws-api.controller');const service_ws_api_controller_1=require('./api/ws/service-ws-api.controller');const analytics_ws_api_controller_1=require('./api/ws/analytics-ws-api.controller');const zappy_app_settings_1=require('./zappy.app.settings');const path=require('path');const socketSession=require('socket.io-mysql-session');const fs=require('fs');const https=require('https');class ZapApp{constructor(port,includeMinerApi=false){this.port=port;this.includeMinerApi=includeMinerApi;this.debugMode=false;this.webRoutes=express_1.Router();this.version='1.6.5';this.restControllers=new Array();this.wsControllers=new Array();this.webApp=express();this.sessionMiddleware=session({secret:'keyboard cat',cookie:{maxAge:60000}});cors({credentials:true,origin:true});this.webApp.use(cors());let useHttps=false;let credentials;let certFile='/etc/letsencrypt/live/topzap.com/privkey.pem';if(fs.existsSync(certFile)){useHttps=true;let privateKey=fs.readFileSync(certFile,'utf8');let certificate=fs.readFileSync('/etc/letsencrypt/live/topzap.com/cert.pem','utf8');let ca=fs.readFileSync('/etc/letsencrypt/live/topzap.com/chain.pem','utf8');credentials={key:privateKey,cert:certificate,ca:ca};}let sessionSettings={secret:'TopCap',cookie:{maxAge:60000}};let http=require('http').Server(this.webApp);let sio=require('socket.io')(http);let dbManager=new db_kernel_1.DbManager();sio.use(new socketSession({db:dbManager.createConnection()}));let sessionMiddleware=session(sessionSettings);sio.use(function(socket,next){sessionMiddleware(socket.request,socket.request.res,next);});this.wsServer=new zyn_socket_server_1.SocketServer();this.wsServer.attachSocketIO(sio);this.webApp.use(sessionMiddleware);this.webApp.use(this.webRoutes);this.serviceClient=new socket_io_client_1.ClientSocket();this.serviceClient.connect(null);this.configureWebServer2();this.initRestControllers();this.initWsControllers();this.port=3000;cli_logger_1.Logger.logPurple(`Starting Server on Port ${this.port}`);if(useHttps){const httpsServer=https.createServer(credentials,this.webApp);httpsServer.listen(8089,()=>{console.log('HTTPS Server running on port 443');});}http.listen(this.port);}getAppVersion(){return'ZapApp-Node-API/'+this.version;}getSecret(){return'ZapApp-Node-API/WillyW0nka';}init(){const routes=this.webRoutes;routes.get('/test',function(req,res){console.log('TypeOf Session ::',typeof req.session);if(req.session.basket){req.session.basket.itemCount++;res.setHeader('Content-Type','text/html');res.write('<p>views: '+req.session.basket.itemCount+'</p>');res.write('<p>expires in: '+req.session.cookie.maxAge/1000+'s</p>');res.end();}else{req.session.basket={type:'basket',itemCount:0};res.end('welcome to the session demo. refresh! :: '+req.session.basket.itemCount);}});routes.get('/minerstats',(req,res)=>{let stat=new miner_status_1.MinerStatus();stat.getProgressInfo().then(data=>{console.log(data);res.render('pages/minerstats',{progData:data});});});this.webApp.use(express.static('public'));this.webApp.use('vendor',express.static('./public/images/vendors'));this.webApp.use('vendors',express.static('public/images/vendors'));this.webApp.use('vendors',express.static('public/images/vendors/'));this.webApp.use('/vendorss',express.static('public/images/vendors/'));this.webApp.use('/vendorsss',express.static('./public/images/vendors/'));this.webApp.use('/vendorssss',express.static(path.join(__dirname,'./public/images/vendors/')));this.webApp.use('/static',express.static(path.join(__dirname,'public')));this.webApp.get('/res/:filename',(req,res)=>{let filename=req.params.code;console.log('Get file',filename);});}initRestControllers(){const routes=this.webRoutes;const controllers=this.restControllers;controllers.push(new service_api_controller_1.ServiceApiController(this.debugMode));controllers.push(new product_api_controller_1.ProductApiController(this.debugMode));controllers.push(new miner_api_controller_1.MinerApiController(this.debugMode));controllers.push(new basket_api_controller_1.BasketApiController(this.debugMode));controllers.push(new data_dump_api_controller_1.DataDumpApiController(this.debugMode));for(let index in controllers){let controller=controllers[index];controller.initRoutes(routes);}}initWsControllers(){const controllers=this.wsControllers;controllers.push(new service_ws_api_controller_1.ServiceWsApiController(this.debugMode));controllers.push(new search_ws_api_controller_1.SearchWsApiController(this.debugMode));controllers.push(new basket_ws_api_controller_1.BasketWsApiController(this.debugMode));controllers.push(new data_cache_controller_1.DataCacheController(this.debugMode));controllers.push(new analytics_ws_api_controller_1.AnalyticsWsApiController(this.debugMode));for(let index in controllers){let controller=controllers[index];controller.attachWSS(this.wsServer);controller.attachServiceClient(this.serviceClient);}}configureWebSocket(){return;let wss=this.wsServer;wss.io.use((socket,next)=>{this.sessionMiddleware(socket.request,socket.request.res,next);});wss.onServerStarted(port=>{cli_logger_1.Logger.logYellow('Websocket IOServer Started on port ::',port);});wss.onError(err=>{cli_logger_1.Logger.logError('Websocket Error ::',err);});wss.onMessage(mess=>{cli_logger_1.Logger.logError('Websocket :: Message ::',mess);});wss.io.sockets.on('connection',socket=>{socket.request.session;});}configureWebServer2(){this.webApp.set('view engine','ejs');this.webApp.use(express.static('public'));this.webApp.use('images',express.static('public/images'));this.webApp.use('/static',express.static(path.join(__dirname,'public')));let routes=this.webRoutes;routes.use(this.sessionMiddleware);routes.use(cookieParser());routes.use(bodyParser.json());routes.use(bodyParser.urlencoded({extended:true}));routes.use(function(err,req,res,next){res.status(err.status||500);let data={'error':{'message':'err.message','error':err}};res.json(data);});}configureWebServer(){let routes=this.webRoutes;this.webApp.set('view engine','ejs');function genuuid(){console.log('Generate ID::::');return'uidSafe(18)';}routes.use(this.sessionMiddleware);routes.use(cookieParser(zappy_app_settings_1.Settings.sessionSecret));routes.use(bodyParser.json());routes.use(bodyParser.urlencoded({extended:true}));let allowCrossDomain=(req,res,next)=>{res.header('Access-Control-Allow-Origin',zappy_app_settings_1.Settings.allowedCORSOrigins);res.header('Access-Control-Allow-Methods','GET,PUT,POST,DELETE');res.header('Access-Control-Allow-Headers','Content-Type');res.header('Access-Control-Allow-Credentials','true');next();};routes.use(allowCrossDomain);routes.use(function(err,req,res,next){res.status(err.status||500);res.render('error',{message:'err.message',error:{}});});}setErrorMiddleware(){if(ZapApp.developmentMode){this.webApp.use(function(err,req,res,next){res.status(err.status||500);res.render('error',{message:err.message,error:err});});}else{this.webApp.use(function(err,req,res,next){res.status(err.status||500);res.render('error',{message:err.message,error:{}});});}}}ZapApp.developmentMode=false;exports.ZapApp=ZapApp;